trigger:
  branches:
    include:
      - main
      - releases/*

jobs:
  - job: "Build"
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet restore'
      inputs:
        command: restore
        projects: src/NBS.Appointments.Service/NBS.Appointments.Service.csproj
    - task: DotNetCoreCLI@2
      displayName: 'dotnet build'
      inputs:
        projects: src/NBS.Appointments.Service/NBS.Appointments.Service.csproj
        arguments: '--output publish_output --configuration Release'
    - task: DotNetCoreCLI@2
      displayName: 'Run unit tests'
      inputs:
        command: 'test'
        projects: |
          src/NBS.Appointments.Service.Unit.Tests/NBS.Appointments.Service.Unit.Tests.csproj
          src/NBS.Appointments.Service.Core.Unit.Tests/NBS.Appointments.Service.Core.Unit.Tests.csproj
    - task: DotNetCoreCLI@2
      displayName: 'Run api tests'
      inputs:
        command: 'test'
        projects: src/NBS.Appointments.Service.Api.Tests/NBS.Appointments.Service.Api.Tests.csproj
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: appointments-service
        dockerfile: src/Dockerfile
        containerRegistry: NbsRegistryServiceConnection
    - task: PublishBuildArtifacts@1
      displayName: "Publish Terraform"
      inputs:
          PathtoPublish: "terraform"
          ArtifactName: "drop_terraform"
          publishLocation: "Container"